# S3 Storage Migration Guide

This guide documents the migration from Supabase Storage to AWS S3 with signed URLs.

## ‚úÖ What Changed

### 1. **Storage Backend**
- **Before**: Supabase Storage (public URLs)
- **After**: AWS S3 (private files with signed URLs)

### 2. **File Access**
- **Before**: Public URLs that never expire
- **After**: Signed URLs that expire after 1 hour (configurable)

### 3. **PDF Generation**
- **Before**: Used PDFKit to combine images
- **After**: Uses PDFKit to combine **Gemini-generated images** (no AI generation in PDF step)

## üìã Setup Instructions

### 1. Install Dependencies

```bash
cd ai__backend
npm install
```

This will install:
- `@aws-sdk/client-s3` - S3 client
- `@aws-sdk/s3-request-presigner` - Signed URL generation

### 2. Configure AWS Credentials

Add to your `.env` file:

```env
# AWS S3 Configuration
AWS_REGION=us-east-1
AWS_S3_BUCKET_NAME=your-bucket-name
AWS_ACCESS_KEY_ID=your_access_key_id
AWS_SECRET_ACCESS_KEY=your_secret_access_key
```

### 3. Create S3 Bucket

1. Go to AWS Console ‚Üí S3
2. Create a new bucket (or use existing)
3. Configure bucket settings:
   - **Block Public Access**: Enable (files are private)
   - **Versioning**: Optional
   - **Encryption**: Recommended (SSE-S3 or SSE-KMS)

### 4. Configure IAM Permissions

Create an IAM user with the following policy:

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "s3:PutObject",
        "s3:GetObject"
      ],
      "Resource": "arn:aws:s3:::your-bucket-name/*"
    }
  ]
}
```

### 5. Update Database (Optional)

If you want to store S3 keys separately for URL regeneration:

```sql
-- Add S3 key columns (optional, for future URL refresh)
ALTER TABLE order_items
ADD COLUMN IF NOT EXISTS pdf_s3_key TEXT,
ADD COLUMN IF NOT EXISTS cover_s3_key TEXT;

-- Create indexes
CREATE INDEX IF NOT EXISTS idx_order_items_pdf_s3_key 
ON order_items(pdf_s3_key) 
WHERE pdf_s3_key IS NOT NULL;

CREATE INDEX IF NOT EXISTS idx_order_items_cover_s3_key 
ON order_items(cover_s3_key) 
WHERE cover_s3_key IS NOT NULL;
```

## üîÑ How It Works

### File Upload Flow

```
1. Gemini generates image (cover or page)
   ‚Üì
2. Image converted to base64
   ‚Üì
3. Upload to S3 (private)
   ‚Üì
4. Generate signed URL (expires in 1 hour)
   ‚Üì
5. Store signed URL in database
```

### PDF Generation Flow

```
1. Gemini generates all page images
   ‚Üì
2. PDFKit combines images into PDF
   ‚Üì
3. PDF uploaded to S3
   ‚Üì
4. Signed URL generated and stored
```

### Download Flow

```
1. User requests download
   ‚Üì
2. App retrieves signed URL from database
   ‚Üì
3. Opens URL in browser/viewer
   ‚Üì
4. If expired, user sees error (can be handled with refresh endpoint)
```

## üîß API Endpoints

### New Endpoint: Generate Signed URL

```http
POST /generate-signed-url
Content-Type: application/json

{
  "s3Key": "books/order_123_item_456_book.pdf",
  "expiresIn": 3600  // Optional, default: 3600 seconds (1 hour)
}
```

**Response:**
```json
{
  "success": true,
  "signedUrl": "https://bucket.s3.amazonaws.com/...?X-Amz-Algorithm=...",
  "expiresIn": 3600
}
```

## üìù Code Changes

### Backend Files Modified

1. **`s3-service.js`** (NEW)
   - S3 upload service
   - Signed URL generation

2. **`order-monitor.js`**
   - Replaced `_uploadToStorage()` with `_uploadToS3()`
   - Updated PDF generation to use Gemini images
   - Added `_getSignedUrlForS3Key()` method

3. **`server.js`**
   - Added `/generate-signed-url` endpoint

4. **`package.json`**
   - Added AWS SDK dependencies

### Flutter App

The Flutter app (`book_generation_service.dart`) already works with signed URLs since it uses `url_launcher` which handles any valid HTTP/HTTPS URL.

**Note**: Signed URLs expire after 1 hour. If a user tries to download after expiration, they'll need a new signed URL. Consider implementing URL refresh logic if needed.

## üö® Important Notes

### Signed URL Expiration

- **Default**: 1 hour (3600 seconds)
- **Configurable**: Can be changed in `order-monitor.js`
- **Storage**: Signed URLs are stored in database
- **Expiration**: URLs become invalid after expiration

### Handling Expired URLs

If you need to handle expired URLs:

1. **Option 1**: Store S3 keys separately and regenerate URLs on-demand
2. **Option 2**: Use longer expiration times (e.g., 24 hours)
3. **Option 3**: Implement refresh endpoint that checks expiration and regenerates

### PDF Generation

The PDF generation now:
- ‚úÖ Uses images **generated by Gemini** (not generating new images)
- ‚úÖ Uses **PDFKit library** to combine images into PDF
- ‚úÖ Maintains A4 page size
- ‚úÖ Handles errors gracefully (continues if one page fails)

## üß™ Testing

### Test S3 Upload

```bash
# Check if S3 service initializes
curl http://localhost:5000/health

# Should show S3 service status in logs
```

### Test Signed URL Generation

```bash
curl -X POST http://localhost:5000/generate-signed-url \
  -H "Content-Type: application/json" \
  -d '{
    "s3Key": "test/file.pdf",
    "expiresIn": 3600
  }'
```

### Test Complete Flow

1. Place an order in Flutter app
2. Wait for processing (check logs)
3. Verify files uploaded to S3
4. Verify signed URLs in database
5. Test download in app

## üîê Security Considerations

1. **Private Files**: All files are private (no public access)
2. **Signed URLs**: Time-limited access
3. **IAM Permissions**: Minimal required permissions
4. **Credentials**: Store in environment variables (never commit)

## üìä Performance

- **Upload Speed**: Similar to Supabase Storage
- **Download Speed**: Depends on AWS region
- **URL Generation**: < 100ms
- **Expiration**: 1 hour default (configurable)

## üêõ Troubleshooting

### S3 Service Not Initialized

**Error**: `S3 service not initialized`

**Solution**: Check environment variables:
```bash
echo $AWS_REGION
echo $AWS_S3_BUCKET_NAME
echo $AWS_ACCESS_KEY_ID
```

### Upload Fails

**Error**: `Failed to upload to S3`

**Solutions**:
1. Verify IAM permissions
2. Check bucket name is correct
3. Verify AWS credentials
4. Check bucket region matches `AWS_REGION`

### Signed URL Expired

**Error**: `403 Forbidden` when accessing URL

**Solution**: 
- URLs expire after 1 hour
- Use `/generate-signed-url` endpoint to refresh
- Or increase expiration time in code

## üìö Additional Resources

- [AWS S3 Documentation](https://docs.aws.amazon.com/s3/)
- [AWS SDK for JavaScript v3](https://docs.aws.amazon.com/sdk-for-javascript/v3/developer-guide/)
- [S3 Signed URLs](https://docs.aws.amazon.com/AmazonS3/latest/userguide/ShareObjectPreSignedURL.html)

---

**Migration Complete!** ‚úÖ

Your system now uses AWS S3 with signed URLs for secure file storage and access.

